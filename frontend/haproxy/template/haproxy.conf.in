#
global
  log 127.0.0.1 local6
  maxconn  ${haproxy-conf:maxconn}
  user     ${haproxy-conf:user}
  group    ${haproxy-conf:group}
  daemon
  nbproc 1

defaults
  mode http
  option httpclose
  # Remove requests from the queue if people press stop button
  option abortonclose
  # Try to connect this many times on failure
  retries 3
  # If a client is bound to a particular backend but it goes down,
  # send them to a different one
  option redispatch
  monitor-uri /haproxy-ping

  timeout connect 7s
  timeout queue   300s
  timeout client  300s
  timeout server  300s

errorfile 503 ${buildout:directory}/template/html/50x.html

  # Enable status page at this URL, on the port HAProxy is bound to
  stats enable
  stats uri /haproxy-status
  stats refresh 5s
  stats realm Haproxy\ statistics
  stats auth admin:vindula

frontend Vindula
  bind ${haproxy-conf:bind_vindula}
  default_backend vindula

# Load balancing over the zope instances
backend vindula
  appsession __ac len 32 timeout 1d
  cookie serverid-SR01 insert nocache indirect
  balance roundrobin
  option httpchk
  
  timeout server  600s
  contimeout      600s
  clitimeout      600s
  srvtimeout      600s

  server  plone-01 10.10.10.10:8081 cookie p-01 check inter 20s maxconn 50 rise 1
  server  plone-02 10.10.10.10:8082 cookie p-02 check inter 20s maxconn 50 rise 1
  server  plone-03 10.10.10.10:8083 cookie p-03 check inter 20s maxconn 50 rise 1

frontend Vindula-APP
  bind ${haproxy-conf:bind_vindula_app}
  default_backend vindulaapp

# Load balancing over the zope instances
backend vindulaapp
  appsession __ac len 32 timeout 1d
  cookie serverid-SR01 insert nocache indirect
  balance roundrobin
  option httpchk GET /vindula-api/admin

  timeout server  600s
  contimeout      600s
  clitimeout      600s
  srvtimeout      600s
  
  server  django-01 10.10.10.10:8000 cookie dj-01 check inter 20s maxconn 150 rise 1

#homolog
frontend Vindula-Homolog
  bind ${haproxy-conf:bind_vindula_homolog}
  default_backend vindula_homolog

# Load balancing over the zope instances
backend vindula_homolog
  appsession __ac len 32 timeout 1d
  cookie serverid-SR01 insert nocache indirect
  balance roundrobin
  option httpchk
  
  timeout server  600s
  contimeout      600s
  clitimeout      600s
  srvtimeout      600s

  server  plone-01 20.20.20.20:8081 cookie ph-01 check inter 20s maxconn 50 rise 1
  server  plone-02 20.20.20.20:8082 cookie ph-02 check inter 20s maxconn 50 rise 1
  server  plone-03 20.20.20.20:8083 cookie ph-03 check inter 20s maxconn 50 rise 1

frontend Vindula-APP-Homolog
  bind ${haproxy-conf:bind_vindula_app_homolog}
  default_backend vindula_app_homolog

# Load balancing over the zope instances
backend vindula_app_homolog
  appsession __ac len 32 timeout 1d
  cookie serverid-SR01 insert nocache indirect
  balance roundrobin
  option httpchk GET /vindula-api/admin

  timeout server  600s
  contimeout      600s
  clitimeout      600s
  srvtimeout      600s
  
  server  django-01 20.20.20.20:8000 cookie djh-01 check inter 20s maxconn 150 rise 1
